# 6D Pose Estimation - Analysis by Synthesis

基于分析合成方法的6D位姿估计工具，使用CMA-ES优化算法将3D网格模型与2D目标图像对齐，估计相机的方位角、仰角和距离参数。

## 🎯 功能特性

- **CMA-ES全局优化**：使用协方差矩阵自适应进化策略进行非线性全局优化
- **双模式匹配**：
  - **Mask模式**：基于二值轮廓的IoU（交并比）匹配
  - **深度梯度模式**：基于Sobel梯度的余弦相似度匹配
- **自适应FOV**：自动计算视场角，确保模型完整显示并占满画面
- **2D对齐**：自动平移和缩放渲染图像以匹配目标图像的位置和大小
- **坐标系转换**：支持Z-Up（建模软件）到Y-Up（渲染引擎）的自动转换
- **可视化输出**：生成优化过程和结果的详细可视化图像

## 📋 依赖安装

```bash
pip install pyrender trimesh cma opencv-python numpy matplotlib
```

## 🚀 快速开始

### 1. 准备文件

将以下文件放置在项目目录下：

```
pose_estimation/
├── pose_estimation.py   # 主程序
├── model.glb            # 3D模型文件（支持 .obj, .stl, .ply, .glb 等）
├── target.png           # 目标图像（灰度深度图或二值掩码）
└── output/              # 输出目录（自动创建）
```

### 2. 配置参数

在 `pose_estimation.py` 文件开头修改配置参数：

```python
# --- 文件路径配置 ---
MESH_PATH = "./model.glb"           # 3D网格文件路径
TARGET_MASK_PATH = "./target.png"   # 目标图像路径
OUTPUT_DIR = "./output"             # 输出目录

# --- 渲染参数 ---
RENDER_WIDTH = 256                  # 渲染宽度
RENDER_HEIGHT = 256                 # 渲染高度

# --- CMA-ES优化参数 ---
CMAES_SIGMA = 5.0                   # 初始步长
CMAES_POPSIZE = 50                  # 种群大小
CMAES_MAXITER = 200                 # 最大迭代次数

# --- 模式选择 ---
USE_DEPTH_GRADIENT = False          # True=深度梯度模式, False=Mask模式
```

### 3. 运行程序

```bash
python pose_estimation.py
```

### 4. 查看结果

输出文件保存在 `./output/` 目录：

| 文件名 | 描述 |
|--------|------|
| `optimization_result.png` | 可视化结果图 |
| `optimized_mask.png` | 对齐后的渲染掩码 |
| `optimized_depth.png` | 对齐后的渲染深度图（深度梯度模式） |
| `estimated_parameters.txt` | 估计的相机参数 |

## 📖 使用指南

### 目标图像要求

- **格式**：PNG灰度图像
- **内容**：
  - **Mask模式**：深度图或二值掩码（非零像素表示前景）
  - **深度梯度模式**：深度图（像素值表示深度）
- **背景**：黑色（像素值为0）

### 参数说明

#### 相机参数（输出）

| 参数 | 描述 | 单位 |
|------|------|------|
| `azimuth` | 方位角 - 相机绕Z轴旋转角度 | 度 (0°~360°) |
| `elevation` | 仰角 - 相机从水平面向上的角度 | 度 (-89°~89°) |
| `distance` | 距离 - 相机到模型中心的距离 | 模型单位 |

#### 优化参数

| 参数 | 默认值 | 描述 |
|------|--------|------|
| `CMAES_SIGMA` | 5.0 | 初始搜索步长，值越大搜索范围越广 |
| `CMAES_POPSIZE` | 50 | 每代评估的候选解数量 |
| `CMAES_MAXITER` | 200 | 最大迭代次数 |
| `CMAES_TOLX` | 1e-5 | 参数收敛容差 |
| `CMAES_TOLFUN` | 1e-6 | 目标函数收敛容差 |

#### 搜索范围

| 参数 | 默认值 | 描述 |
|------|--------|------|
| `AZIMUTH_RANGE` | (0, 2π) | 方位角搜索范围（弧度） |
| `ELEVATION_RANGE` | (-89°, 89°) | 仰角搜索范围（度） |
| `DISTANCE_MIN` | 0.8 | 最小距离倍数（相对于模型对角线） |
| `DISTANCE_MAX` | 5.0 | 最大距离倍数（相对于模型对角线） |

### 模式选择

#### Mask模式 (`USE_DEPTH_GRADIENT = False`)

- 将目标图像二值化后与渲染轮廓比较
- 使用IoU（交并比）作为相似度指标
- 适用于：轮廓清晰、形状简单的物体
- 优点：计算快速，对噪声不敏感

#### 深度梯度模式 (`USE_DEPTH_GRADIENT = True`)

- 使用Sobel算子提取深度图的梯度
- 使用余弦相似度比较梯度分布
- 适用于：有复杂几何细节的物体
- 优点：能捕捉几何结构信息

## 🔬 算法原理

### 分析合成方法 (Analysis by Synthesis)

1. **合成**：给定相机参数，渲染3D模型得到2D图像
2. **分析**：计算渲染图像与目标图像的相似度
3. **优化**：使用CMA-ES搜索使相似度最大化的相机参数

### CMA-ES优化

CMA-ES（协方差矩阵自适应进化策略）是一种无梯度的全局优化算法：

- 维护一个多元正态分布来采样候选解
- 根据候选解的适应度更新分布参数
- 自适应调整搜索方向和步长
- 能够跳出局部最优，找到全局最优解

### 2D对齐

为了使优化专注于姿态匹配而非位置匹配，在计算相似度前进行2D对齐：

1. 计算两个mask的质心，进行平移对齐
2. 计算两个mask的AABB包围盒，进行等比例缩放
3. 使用仿射变换应用对齐

## ⚠️ 注意事项

1. **坐标系**：程序内部使用Y-Up坐标系（pyrender标准），输出参数为Z-Up坐标系（建模软件标准）
2. **阈值**：目标图像使用阈值1进行二值化，适配深度灰度图
3. **距离单位**：输出的距离为模型原始单位，可通过相对距离换算
4. **自检模式**：如果目标图像不存在，程序会自动生成测试用例

## 📝 License

MIT License

## 🤝 贡献

欢迎提交Issue和Pull Request！
